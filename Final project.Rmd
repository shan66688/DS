---
title: "P8106 Data Science II Final Project"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(magrittr)
library(knitr)
library(readr)
library(tidyverse)
library(haven)
library(readxl)
library(caret)
library(ISLR)
library(pls)
library(pROC)
library(class)
library(rpart)
library(party)
library(partykit)
library(tree)
library(randomForest)
library(gbm)
library(pander)
library(e1071)
library(tidytext)
library(tools)
library(openintro)
```

## R Markdown

#best group start here 

###1. data preparation.

####1. Read raw data
```{r}
# read in raw data
drug_data = read.csv("../data/State_Drug_Utilization_Data_2015.csv")
drug_name = read_xlsx("../data/anxiety drug names.xlsx")
sunshine = read_xlsx("../data/sunshine duration by state.xlsx")
acs2015 = read.csv("../data/acs2015_county_data.csv")
happy_rank = c(28, 2, 9, 44, 10, 4, 18, 27, 12, 41, 1, 36, 35, 46, 14, 25, 49, 42, 22, 34, 30, 39, 7, 43, 45, 3, 20, 38, 21, 32, 16, 40, 23, 15, 47, 48, 31, 33, 26, 19, 6, 37, 11, 8, 29, 17, 24, 50, 13, 5)
happy = data.frame(cbind(state.name, happy_rank)) %>%
  mutate(State = state.name) %>%
  select(-state.name)
physician=read_xlsx("../data/physician.xlsx")
save(drug_data,drug_name,sunshine,acs2015,happy,physician, file="raw_data.Rdata")
```

####2. Summarize acs2015 data by state, and save it as "acs_summary_by_state.Rdata".
```{r}
# #acs data summary by state
# acs2015_summary = acs2015 %>%
#   group_by(State) %>%
#   summarize(population = sum(TotalPop, na.rm = TRUE), 
#             men = sum(Men, na.rm = TRUE)/population,
#             women = sum(Women, na.rm = TRUE)/population,
#             hispanic = sum(0.01*Hispanic * TotalPop, na.rm = TRUE)/population,
#             white = sum(0.01*White * TotalPop, na.rm = TRUE)/population,
#             black = sum(0.01*Black * TotalPop, na.rm = TRUE)/population,
#             asian = sum(0.01*Asian * TotalPop, na.rm = TRUE)/population,
#             native = sum(0.01*Native * TotalPop, na.rm = TRUE)/population,
#             pacific = sum(0.01*Pacific * TotalPop, na.rm = TRUE)/population,
#             citizen = sum(Citizen, na.rm = TRUE)/population,
#             ave_income = sum(Income * TotalPop, na.rm = TRUE)/population,
#             income_per_cap = sum(as.numeric(IncomePerCap) * TotalPop, na.rm = TRUE)/population,
#             ave_Poverty = sum(Poverty * TotalPop, na.rm = TRUE)/population,
#             ave_ChildPoverty = sum(ChildPoverty * TotalPop, na.rm = TRUE)/population,
#             ave_Professional = sum(Professional * TotalPop, na.rm = TRUE)/population,
#             ave_Service = sum(Service * TotalPop, na.rm = TRUE)/population,
#             ave_Office = sum(Office * TotalPop, na.rm = TRUE)/population,
#             ave_Construction = sum(Construction * TotalPop, na.rm = TRUE)/population,
#             ave_Production = sum(Production * TotalPop, na.rm = TRUE)/population,
#             ave_Drive = sum(Drive * TotalPop, na.rm = TRUE)/population,
#             ave_Carpool = sum(Carpool * TotalPop, na.rm = TRUE)/population,
#             ave_Transit = sum(Transit * TotalPop, na.rm = TRUE)/population,
#             ave_Walk = sum(Walk * TotalPop, na.rm = TRUE)/population,
#             ave_WorkAtHome = sum(WorkAtHome * TotalPop, na.rm = TRUE)/population,
#             ave_MeanCommute = sum(MeanCommute * TotalPop, na.rm = TRUE)/population,
#             ave_SelfEmployed = sum(SelfEmployed * Employed, na.rm = TRUE)/sum(Employed),
#             ave_PublicWork = sum(PublicWork * Employed, na.rm = TRUE)/sum(Employed),
#             ave_PrivateWork = sum(PrivateWork * Employed, na.rm = TRUE)/sum(Employed),
#             ave_FamilyWork = sum(FamilyWork * Employed, na.rm = TRUE)/sum(Employed),
#             ave_Unemployment = sum(Unemployment * TotalPop, na.rm = TRUE)/population)
# 
# save(acs2015_summary, file = "acs_summary_by_state.Rdata")
```

####3. Prepare the drug_name data: get all the names ready for "join" and save it as "drug name.Rdata".
```{r}
# drug_name_1 = drug_name %>%
#   unnest_tokens(word, name) %>%
#   unique()
# 
# data("stop_words")
# drug_name_2 = anti_join(drug_name_1, stop_words) %>%
#   mutate(word_upper = toupper(word), word_first_upper = toTitleCase(word)) %>%
#   gather(type, Product.Name, 1:3) %>%
#   select(Product.Name)
# 
# save(drug_name_2, file = "drug name.Rdata")
```

####4. Select anti-anxiety drug by merging drug_data with "drug name.Rdata"(drug_name_2), and summarize by state. The result is "anxiety drug by state.Rdata".
```{r}
# drug_data_anxiety_state = merge(drug_name_2, drug_data) %>%
#   mutate(Units.Reimbursed = as.numeric(Units.Reimbursed),
#          Number.of.Prescriptions = as.numeric(Number.of.Prescriptions),
#          Total.Amount.Reimbursed = as.numeric(Total.Amount.Reimbursed),
#          Medicaid.Amount.Reimbursed = as.numeric(Medicaid.Amount.Reimbursed),
#          State = abbr2state(State)) %>%
#   filter(Number.of.Prescriptions > 1, !is.na(State)) %>%
#   mutate(Product.Name = toupper(Product.Name)) %>%
#   group_by(State, Product.Name) %>%
#   summarise(Rx.Number = sum((Number.of.Prescriptions), na.rm=TRUE),
#             Reimburse.Unit = sum((Units.Reimbursed), na.rm=TRUE),
#             Reimburse.Amount.Tot = sum((Total.Amount.Reimbursed), na.rm=TRUE),
#             Reimburse.Amount.Medicaid = sum((Medicaid.Amount.Reimbursed), na.rm=TRUE))
# 
# save(drug_data_anxiety_state, file = "anxiety drug by state.Rdata")
```

####5. Merge all data sets by state, and save as "data.Rdata", which is our final data set for now.
```{r}
# geo_center = data.frame(cbind(state.name, state.center$x, state.center$y))
# colnames(geo_center)<-(c("State", "longitude", "latitude"))
# 
# data = Reduce(function(x, y) merge(x, y, all=TRUE), list(acs2015_summary, drug_data_anxiety_state, happy, physician, sunshine, geo_center)) 
# 
# save(data, file = "data.Rdata")
```

Description of "data" variables:
"State": 50 states plus DC.
"population": Total population in the state.
"men" and "women": Proportion of men or women in the population. They add up to 1.
"hispanic", "white", "black", "asian", "native", and "pacific": Proportion of each race in the population. They add up to 1.
"citizen": Proportion of citizen.
"ave_income": Average annual income of each employee.
"income_per_cap": Average annual income per capita.
"ave_Poverty": average poverty
"ave_ChildPoverty": average child poverty
"ave_Professional", "ave_Service", "ave_Office", "ave_Construction", "ave_Production": Percetage of employee working in a specific career. They add up to 100.
"ave_Drive", "ave_Carpool", "ave_Transit", "ave_Walk": Percetage of people taking a specific commuting method. They add up to 100.
"ave_MeanCommute": I am not quite sure. Probably the commuting time in minutes?
"ave_SelfEmployed", "ave_PublicWork", "ave_PrivateWork", "ave_FamilyWork": Percetage of people with a specific employment status. They add up to 100.
"ave_Unemployment": Unemployment rate.
"Product.Name": Name of the drug
"Rx number": number of prescriptions.
"Reimburse.Unit": No idea...
"Reimburse.Amount.Tot": Total amount of reimbursment for a drug.
"Reimburse.Amount.Medicaid": Total amount of reimbursment by Medicaid for a drug.
"happy_rank": The rank of happiness of the state among all 50 states.
"physician per 100,000 population": Licensed, active physician per 100,000 population.
"Place", "% Sun", "Total hours", "Clear days": These are for the sunshine data. "Place" is where the following three measurements were taken.
"Longitude" and "Latitude": The coordinates of the geometric center of each state.


We probably will use "Rx number", "Reimburse.Amount.Tot", or "Reimburse.Amount.Medicaid" as the reponse, and the other variables as the predictors.







